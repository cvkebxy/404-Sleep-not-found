# Как добавить / редактировать карту (nko.csv)

Кратко: правка карты производится в Конструкторе карт Яндекса через импорт/редактирование CSV, затем сохранённый CSV кладут обратно в папку проекта /data (замена старого nko.csv). Для показа карты на сайте нужен Yandex API key — получить в кабинете разработчика и вставить в index.php.

---

## Общая последовательность действий

1. Резервная копия
   - Перед изменениями сделайте бэкап текущего файла:
   ```bash
   cp data/nko.csv data/nko.csv.bak
   ```

2. Импорт в Конструктор карт Яндекса
   - Откройте https://yandex.ru/map-constructor
   - Создайте новую карту или откройте существующую.
   - Выберите опцию импорта/добавления объектов → загрузка файла → выберите ваш файл `nko.csv` из папки проекта.
   - В процессе импорта укажите:
     - Кодировка: UTF-8 (без BOM).
     - Разделитель полей: `;` (точка с запятой).
     - Колонки, которые соответствуют координатам: поле широты и поле долготы (в нашем CSV — "Широта" и "Долгота").
   - Проверьте, что точки отображаются корректно по координатам.

3. Редактирование объектов в Конструкторе карт
   - Добавляйте, редактируйте или удаляйте метки через интерфейс конструктора (изменить подписи, описание, иконки и т.д.).
   - При необходимости изменяйте атрибуты объекта (название, описание/тип, ссылка).

4. Экспорт / сохранение в формате CSV
   - После правок выберите экспорт карты → формат CSV.
   - Скачайте CSV и убедитесь, что:
     - Кодировка UTF-8 без BOM.
     - Разделитель — `;`.
     - Структура колонок соответствует ожиданиям проекта (минимум: "Широта";"Долгота";"Описание";"Подпись").
     - Координаты в числовом формате с десятичной точкой (пример: 55.763594).
   - Если Map Constructor экспортирует в другой структуре — привведите файл к требуемому формату (переименуйте заголовки колонок, удалите лишние колонки или убедитесь в порядке).

5. Замена файла в проекте
   - Положите итоговый `nko.csv` в папку проекта `/data`, заменив предыдущий:
   ```bash
   mv ~/Downloads/nko.csv /path/to/project/data/nko.csv
   ```
   - Убедитесь, что веб‑сервер может читать файл:
   ```bash
   chown www-data:www-data /path/to/project/data/nko.csv   # пример для Linux/nginx
   chmod 640 /path/to/project/data/nko.csv
   ```

6. Тестирование на сайте
   - Откройте страницу с картой (например, http://localhost:8000/index.php) и обновите.
   - Проверьте:
     - Появились все новые/отредактированные точки.
     - Фильтры и поиск корректно работают для новых данных.
     - Всплывающие окна (balloonContent) показывают ожидаемую информацию.

7. API ключ Яндекса (если нужно поменять / добавить свой)
   - Получить ключ: https://developer.tech.yandex.ru/services
     - Зарегистрируйтесь/авторизуйтесь, создайте новое приложение/ключ для Yandex.Maps JS API (JavaScript API и HTTP Геокодер).
     - Ограничьте ключ по домену/рефереру (рекомендуется).
   - Добавьте/замените ключ в index.php:
   ```php
   <script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU&apikey=ВАШ_АПИ_КЛЮЧ" type="text/javascript"></script>
   ```
   - Не коммитьте рабочий ключ в публичный репозиторий. Вместо этого используйте `php/config.php` (в .gitignore) или переменные окружения и подставляйте ключ в шаблон.

---

## Формат CSV — требования и советы
- Кодировка: UTF-8 без BOM.
- Разделитель: `;`.
- Заголовки колонок (рекомендуемые, те что использует код):
  - "Широта" — latitude (число, с точкой)
  - "Долгота" — longitude (число, с точкой)
  - "Описание" — длинный текст, из которого парсится тип (код ищет "Деятельность НКО: <тип>")
  - "Подпись" — название организации
  - Дополнительные поля (телефон, сайт и т.п.) — можно добавить, но при необходимости нужно обновить main.js, чтобы помещать их в balloonContent
- Координаты: использовать десятичные значения с точкой (пример: 55.763594, не 55,763594).
- Если экспорт даёт другие названия колонок — переименуйте заголовки в CSV в ожидаемые.

---

## Полезные рекомендации / частые ошибки
- Ошибка: точки не появляются — проверьте, что координаты не пустые и содержат точки (.), а не запятые.
- Ошибка: CSV не загружается браузером — проверьте путь к `data/nko.csv`, права и отсутствие CORS (если файл отдаётся с другого домена).
- Если много объектов и карта медленно загружается — экспортируйте GeoJSON и отдавайте его напрямую клиенту или используйте серверную предобработку.
- Всегда делайте бэкап (`nko.csv.bak`) перед заменой.
- После массовых правок лучше очистить кеш браузера и/или статических ресурсов.

---

## Если нужно автоматизировать
- Можно написать простой скрипт для валидации CSV (проверка кодировки, наличия обязательных колонок, формата координат) — пригодится перед заменой файла на проде.
- Возможна автоматическая генерация GeoJSON из CSV и размещение `data/points.geojson` для более быстрого рендеринга.
```
